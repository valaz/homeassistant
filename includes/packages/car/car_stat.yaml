car_stat:
  timer:
    car_integration_check:
      name: "–ü—Ä–æ–≤–µ—Ä–∫–∞ VW –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏"
      duration: "00:30:00"

  automation:
    - alias: "[Car] Report Last Trip info"
      mode: restart
      initial_state: true
      trigger:
        - platform: state
          entity_id: binary_sensor.passat_gte_vehicle_moving
          to: "off"
          for: "02:00:00"
      action:
        - service: notify.tg_car_chat
          data:
            title: üöôüìä –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–µ–∑–¥–∫–∞
            message: |
              –í—Ä–µ–º—è: {{ as_timestamp(states('sensor.passat_gte_parking_time')) | timestamp_custom('%d %b %Y, %H:%M', true) }}
              –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: {{ states('sensor.passat_gte_last_trip_length') }} –∫–º
              –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {{ states('sensor.passat_gte_last_trip_duration') }} –º–∏–Ω
              –°—Ä–µ–¥–Ω–Ω—è —Å–∫–æ—Ä–æ—Å—Ç—å: {{ states('sensor.passat_gte_last_trip_average_speed') }} –∫–º/—á
              –†–∞—Å—Ö–æ–¥ –±–∞—Ç–∞—Ä–µ–∏: {{ states('sensor.passat_gte_last_trip_average_electric_engine_consumption') }} –∫–í—Ç—á/100 km
              –†–∞—Å—Ö–æ–¥ –±–µ–Ω–∑–∏–Ω–∞: {{ states('sensor.passat_gte_last_trip_average_fuel_consumption') }} –ª/100 –∫–º
              –¢–µ–∫—É—â–∏–π –ø—Ä–æ–±–µ–≥: {{ states('sensor.passat_gte_odometer') }} –∫–º
              ‚õΩ –¢–æ–ø–ª–∏–≤–æ: {{ states('sensor.passat_gte_fuel_level') }}% ({{ states('sensor.passat_gte_fuel_range') }} –∫–º)
              üîã –ë–∞—Ç–∞—Ä–µ—è: {{ states('sensor.passat_gte_battery_level') }}% ({{ states('sensor.passat_gte_electric_range') }} –∫–º)

    - alias: "[Car] Reload Integration"
      mode: restart
      initial_state: true
      trigger:
        - platform: state
          entity_id: sensor.passat_gte_odometer
          to: "unavailable"
          for: "00:10:00"
        - platform: event
          event_type: timer.finished
          event_data:
            entity_id: timer.car_integration_check
      conditions:
        - condition: state
          entity_id: sensor.passat_gte_odometer
          state: "unavailable"
      action:
        - service: notify.tg_car_chat
          data:
            title: üöôüîÉ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
            message: |
              –¢–µ–∫—É—â–µ–µ –í—Ä–µ–º—è: {{ states('sensor.time') }}
        - service: homeassistant.reload_config_entry
          target:
            entity_id: sensor.passat_gte_odometer
        - service: timer.cancel
          target:
            entity_id: timer.car_integration_check
        - service: timer.start
          target:
            entity_id: timer.car_integration_check
