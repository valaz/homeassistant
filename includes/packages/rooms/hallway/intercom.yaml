intercom:
  timer:
    hallway_intercom_auto_open_timer:
      name: "Автооткрытие подъезда"
      duration: "00:05:00"

  lock:
    - platform: template
      unique_id: c_intercom
      name: Intercom
      value_template: "{{ is_state('switch.c_intercom_autoopen', 'off') }}"
      lock:
        - service: switch.turn_off
          target:
            entity_id: switch.c_intercom_autoopen
      unlock:
        - service: switch.turn_on
          target:
            entity_id: switch.c_intercom_autoopen

  switch:
    - platform: template
      switches:
        c_intercom_autoopen:
          friendly_name: "Intercom Autoopen"
          value_template: >-
            {{ not is_state("timer.hallway_intercom_auto_open_timer", "idle") }}
          turn_on:
            - service: timer.cancel
              target:
                entity_id: timer.hallway_intercom_auto_open_timer
            - service: timer.start
              target:
                entity_id: timer.hallway_intercom_auto_open_timer
          turn_off:
            - service: timer.cancel
              target:
                entity_id: timer.hallway_intercom_auto_open_timer

  automation:
    - alias: "[Intercom] Autoopen"
      mode: restart
      initial_state: true
      trigger:
        - platform: state
          entity_id: binary_sensor.front_entrance_ding
          to: "on"
        - platform: state
          entity_id: lock.intercom
          to: "unlocked"
      condition:
        - condition: state
          entity_id: lock.intercom
          state: "unlocked"
        - condition: state
          entity_id: binary_sensor.front_entrance_ding
          state: "on"
      action:
        - service: script.intercom_door_try_warmup
        - service: switch.toggle
          target:
            entity_id: switch.hallway_button_pusher
        - service: button.press
          target:
            entity_id: button.front_entrance_open_door
