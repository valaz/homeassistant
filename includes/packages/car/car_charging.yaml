car_charging:
  template:
    - sensor:
        - name: "Passat GTE Charging Finish Time Raw"
          unique_id: passat_gte_charging_finish_time_raw
          device_class: timestamp
          state: >
            {% set minutes_str = states('sensor.passat_gte_charging_time_left') %}
            {% if minutes_str in ['unknown', 'unavailable', '', None] %}
              {{ 'unknown' }}
            {% else %}
              {% set minutes = minutes_str | int(0) %}
              {% set last_updated = states.sensor.passat_gte_charging_time_left.last_updated %}
              {{ (last_updated + timedelta(minutes=minutes)).isoformat() }}
            {% endif %}
        - name: "Passat GTE Charging Finish Time"
          unique_id: passat_gte_charging_finish_time
          # device_class: timestamp
          state: >
            {% set charge_time_raw = states('sensor.passat_gte_charging_finish_time_raw') %}
            {% if charge_time_raw in ['unknown', 'unavailable', '', None] %}
              {{ 'unknown' }}
            {% else %}
              {{ as_timestamp(charge_time_raw) | timestamp_custom('%H:%M', true) }}
            {% endif %}

  automation:
    - alias: "[Car] Notify about electric charge progress"
      mode: restart
      initial_state: true
      trigger:
        - platform: numeric_state
          entity_id: sensor.passat_gte_battery_level
          above: 19
          below: 40
        - platform: numeric_state
          entity_id: sensor.passat_gte_battery_level
          above: 39
          below: 60
        - platform: numeric_state
          entity_id: sensor.passat_gte_battery_level
          above: 59
          below: 80
        - platform: numeric_state
          entity_id: sensor.passat_gte_battery_level
          above: 79
          below: 90
        - platform: numeric_state
          entity_id: sensor.passat_gte_battery_level
          above: 89
          below: 95
        - platform: numeric_state
          entity_id: sensor.passat_gte_battery_level
          above: 94
          below: 100
      condition:
        - condition: state
          entity_id: binary_sensor.passat_gte_external_power
          state: "on"
        - condition: numeric_state
          entity_id: sensor.passat_gte_battery_level
          below: 100
      action:
        - service: notify.tg_car_chat
          data:
            message: |
              üöôüîå –ê–≤—Ç–æ –∑–∞—Ä—è–∂–µ–Ω –Ω–∞ {{ states('sensor.passat_gte_battery_level') }}%
              –î–æ –∫–æ–Ω—Ü–∞ –∑–∞—Ä—è–¥–∫–∏ –æ—Å—Ç–∞–ª–æ—Å—å {{ states('sensor.passat_gte_charging_time_left') }} –º–∏–Ω.
        - service: script.send_sms_to_azat
          data:
            message: |
              üöôüîå –ê–≤—Ç–æ –∑–∞—Ä—è–∂–µ–Ω –Ω–∞ {{ states('sensor.passat_gte_battery_level') }}%.
              –î–æ –∫–æ–Ω—Ü–∞ –∑–∞—Ä—è–¥–∫–∏ –æ—Å—Ç–∞–ª–æ—Å—å {{ states('sensor.passat_gte_charging_time_left') }} –º–∏–Ω.

    - alias: "[Car] Notify when battery is fully charged"
      mode: restart
      initial_state: true
      trigger:
        - platform: numeric_state
          entity_id: sensor.passat_gte_battery_level
          above: 99
      action:
        - service: notify.tg_car_chat
          data:
            message: |
              üöôüîã –ê–≤—Ç–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞—Ä—è–∂–µ–Ω ({{ states('sensor.passat_gte_battery_level') }}%).
              –ó–∞–ø–∞—Å —Ö–æ–¥–∞ –Ω–∞ –±–∞—Ç–∞—Ä–µ–µ: {{ states('sensor.passat_gte_electric_range') }} –∫–º.
        - service: script.send_sms_to_azat
          data:
            message: |
              üöôüîã –ê–≤—Ç–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞—Ä—è–∂–µ–Ω ({{ states('sensor.passat_gte_battery_level') }}%).
              –ó–∞–ø–∞—Å —Ö–æ–¥–∞ –Ω–∞ –±–∞—Ç–∞—Ä–µ–µ: {{ states('sensor.passat_gte_electric_range') }} –∫–º.

    - alias: "[Car] Notify on full fuel refill"
      mode: restart
      initial_state: true
      trigger:
        - platform: numeric_state
          entity_id: sensor.passat_gte_fuel_level
          above: 98
      action:
        - service: notify.tg_car_chat
          data:
            message: |
              üöô‚õΩ –ê–≤—Ç–æ –∑–∞–ø—Ä–≤–ª–µ–Ω –Ω–∞ {{ states('sensor.passat_gte_fuel_level') }}%.
              –ü—Ä–æ–±–µ–≥: {{ states('sensor.passat_gte_odometer') }} –∫–º.
              –ó–∞–ø–∞—Å —Ö–æ–¥–∞ –Ω–∞ –±–µ–Ω–∑–∏–Ω–µ: {{ states('sensor.passat_gte_fuel_range') }} –∫–º

    - alias: "[Car] Enable fast charging"
      mode: restart
      initial_state: true
      trigger:
        - platform: numeric_state
          entity_id: sensor.passat_gte_battery_level
          below: 80
      actions:
        - service: switch.turn_off
          target:
            entity_id: switch.passat_gte_reduced_ac_charging
